<%@ page language="java" contentType="text/html; charset=UTF-8"
pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ì¥ë°”êµ¬ë‹ˆ | Stationery Shop</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
      :root {
        --primary: #dc0630; /* ë©”ì¸ ë ˆë“œ */
        --primary-weak: #ffdde2; /* ì—°í•œ ë ˆë“œ ë°°ê²½ */
        --ink: #1f1f1f; /* ë³¸ë¬¸ í…ìŠ¤íŠ¸ */
        --muted: #70757a;
        --line: #eee; /* ë¼ì¸ */
        --bg: #ffffff; /* ì¹´ë“œ/ë°°ê²½ */
        --shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
      }

      body {
        margin: 0;
        background: #fafafa;
        font-family: "Pretendard", "Apple SD Gothic Neo", system-ui,
          -apple-system, Segoe UI, Roboto, sans-serif;
        color: var(--ink);
      }
      .container {
        max-width: 1100px;
        margin: 40px auto;
        padding: 28px;
        background: var(--bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--line);
      }
      h1 {
        margin: 0 0 8px;
        text-align: center;
        font-size: 28px;
        color: var(--primary);
      }
      .sub {
        text-align: center;
        color: var(--muted);
        margin-bottom: 20px;
      }

      .breadcrumb {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 14px;
      }
      .breadcrumb a {
        color: var(--muted);
        text-decoration: none;
      }
      .breadcrumb strong {
        color: var(--ink);
      }

      /* Table */
      .cart-table {
        width: 100%;
        border-collapse: collapse;
      }
      .cart-table th,
      .cart-table td {
        padding: 14px 10px;
        border-bottom: 1px solid var(--line);
        vertical-align: middle;
      }
      .cart-table th {
        background: #fff;
        color: #444;
        font-weight: 700;
        border-top: 1px solid var(--line);
      }
      .col-check {
        width: 44px;
        text-align: center;
      }
      .col-img {
        width: 84px;
      }
      .prod {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .prod img {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      .prod .name {
        font-weight: 700;
      }
      .prod .opts {
        font-size: 12px;
        color: var(--muted);
      }

      /* Buttons */
      .btn {
        border: none;
        border-radius: 10px;
        padding: 9px 14px;
        font-weight: 800;
        cursor: pointer;
        transition: 0.15s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .btn-primary {
        background: var(--primary);
        color: #fff;
      }
      .btn-primary:hover {
        filter: brightness(0.95);
      }
      .btn-ghost {
        background: #fff;
        color: var(--primary);
        border: 1px solid var(--primary);
      }
      .btn-ghost:hover {
        background: var(--primary-weak);
      }

      /* Qty */
      .qty {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #fff;
      }
      .qty input {
        width: 44px;
        text-align: center;
        border: none;
        outline: none;
        font-weight: 700;
        color: var(--ink);
      }

      .price {
        font-weight: 800;
      }
      .text-right {
        text-align: right;
      }

      /* Summary cards */
      .summary {
        margin-top: 22px;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }
      .card {
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 16px;
        box-shadow: var(--shadow);
      }
      .card .label {
        font-size: 12px;
        color: var(--muted);
      }
      .card .value {
        font-size: 20px;
        font-weight: 900;
        margin-top: 6px;
        color: var(--ink);
      }
      #sum-total {
        color: var(--primary);
      }

      .actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin: 14px 0 20px;
      }
      .checkout {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 14px;
      }

      /* Accent row on hover */
      #cart-body tr:hover {
        background: #fffafa;
      }

      /* Mobile */
      @media (max-width: 720px) {
        .summary {
          grid-template-columns: 1fr 1fr;
        }
        .actions,
        .checkout {
          flex-direction: column;
          align-items: stretch;
        }
        .prod .opts {
          display: none;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="breadcrumb">
        <a href="/main.do">í™ˆ</a> <span>â€º</span> <strong>ì¥ë°”êµ¬ë‹ˆ</strong>
      </div>

      <h1>ğŸ‘§ğŸ» ì¥ë°”êµ¬ë‹ˆ</h1>
      <div class="sub">
        ë‹´ê¸´ ìƒí’ˆì€ <b>7ì¼</b>ê°„ ë³´ê´€ë¼ìš”. ê²°ì œ ì „ê¹Œì§€ ì¬ê³ /ê°€ê²©ì´ ë³€ë™ë  ìˆ˜
        ìˆì–´ìš”.
      </div>

      <!-- ìƒë‹¨ íˆ´ë°” -->
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
        "
      >
        <label
          style="display: flex; align-items: center; gap: 8px; color: #5d4037"
        >
          <input type="checkbox" id="headCheck" /> ì „ì²´ì„ íƒ
        </label>
        <div class="actions">
          <button class="btn-ghost btn" id="btnDelSel">ì„ íƒì‚­ì œ</button>
          <button class="btn-ghost btn" id="btnWishSel">ì„ íƒê´€ì‹¬</button>
        </div>
      </div>

      <!-- ì¥ë°”êµ¬ë‹ˆ í…Œì´ë¸” -->
      <table class="cart-table">
        <thead>
          <tr>
            <th class="col-check"></th>
            <th class="col-img"></th>
            <th>ìƒí’ˆì •ë³´</th>
            <th class="text-right">ê°€ê²©</th>
            <th>ìˆ˜ëŸ‰</th>
            <th class="text-right">í•©ê³„</th>
            <th class="text-right">ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="cart-body">
          <!-- JS ë Œë”ë§ -->
        </tbody>
      </table>

      <!-- í•˜ë‹¨ ë²„íŠ¼ -->
      <div class="actions">
        <button class="btn-ghost btn" id="btnDelSel2">ì„ íƒì‚­ì œ</button>
        <button class="btn-ghost btn" id="btnWishSel2">ì„ íƒê´€ì‹¬</button>
      </div>

      <!-- í•©ê³„ -->
      <div class="summary">
        <div class="card">
          <div class="label">ìƒí’ˆê¸ˆì•¡</div>
          <div class="value" id="sum-products">â‚© 0</div>
        </div>
        <div class="card">
          <div class="label">í• ì¸ê¸ˆì•¡</div>
          <div class="value" id="sum-discount">â‚© 0</div>
        </div>
        <div class="card">
          <div class="label">ë°°ì†¡ë¹„</div>
          <div class="value" id="sum-shipping">â‚© 0</div>
        </div>
        <div class="card">
          <div class="label">ê²°ì œì˜ˆì •ê¸ˆì•¡</div>
          <div class="value" id="sum-total">â‚© 0</div>
        </div>
      </div>

      <div class="checkout">
        <button class="btn" id="btnOrderSel">ì„ íƒìƒí’ˆ ì£¼ë¬¸</button>
        <button class="btn" id="btnOrderAll">ì „ì²´ìƒí’ˆ ì£¼ë¬¸</button>
      </div>
    </div>

    <script>
      /* ---------------------------
     ìœ í‹¸
  ----------------------------*/
      const fmt = (n) =>
        "â‚© " +
        Math.round(n)
          .toString()
          .replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      const clampQty = (q) => Math.max(1, parseInt(q || 1, 10));

      /* ---------------------------
     ë”ë¯¸ ë°ì´í„° (ë°±ì—”ë“œ ì—°ë™ ì „ í…ŒìŠ¤íŠ¸ìš©)
     - price: í˜„ì¬ê°€(ì›)
     - discount: ê°œë‹¹ í• ì¸ì•¡(ì›)
  ----------------------------*/
      let cart = [
        {
          id: 101,
          name: "ì ¤íœ 0.5mm (ë¸”ë™)",
          opts: "ì˜µì…˜: 0.5 / ë¸”ë™",
          price: 1200,
          discount: 0,
          qty: 2,
          img: "https://picsum.photos/seed/pen/80",
          checked: true,
        },
        {
          id: 102,
          name: "A5 ë„íŠ¸ ë…¸íŠ¸",
          opts: "ì˜µì…˜: A5 / 80ë§¤",
          price: 3500,
          discount: 300,
          qty: 1,
          img: "https://picsum.photos/seed/note/80",
          checked: true,
        },
        {
          id: 103,
          name: "ë§ˆì»¤ 6ìƒ‰ ì„¸íŠ¸",
          opts: "ì˜µì…˜: íŒŒìŠ¤í…”",
          price: 7800,
          discount: 800,
          qty: 1,
          img: "https://picsum.photos/seed/marker/80",
          checked: false,
        },
      ];

      /* ---------------------------
     ë Œë”ë§
  ----------------------------*/
      function render() {
        const $tbody = $("#cart-body").empty();
        cart.forEach((item) => {
          const line = (item.price - item.discount) * item.qty;
          const $tr = $(`
        <tr data-id="${item.id}">
          <td class="col-check">
            <input type="checkbox" class="rowCheck" ${
              item.checked ? "checked" : ""
            }>
          </td>
          <td class="col-img">
            <img src="${item.img}" alt="">
          </td>
          <td>
            <div class="prod">
              <div class="meta">
                <div class="name">${escapeHtml(item.name)}</div>
                <div class="opts">${escapeHtml(item.opts || "")}</div>
              </div>
            </div>
          </td>
          <td class="text-right">
            <div>ìƒí’ˆê°€: <span class="price">${fmt(item.price)}</span></div>
            ${
              item.discount > 0
                ? `<div style="color:#d32f2f">í• ì¸: âˆ’${fmt(
                    item.discount
                  )}</div>`
                : ""
            }
          </td>
          <td>
            <div class="qty">
              <button class="btn-ghost btn btnMinus" aria-label="ìˆ˜ëŸ‰ê°ì†Œ">âˆ’</button>
              <input type="number" class="qtyInput" min="1" value="${item.qty}">
              <button class="btn-ghost btn btnPlus" aria-label="ìˆ˜ëŸ‰ì¦ê°€">ï¼‹</button>
            </div>
          </td>
          <td class="text-right">
            <div class="price lineTotal">${fmt(line)}</div>
          </td>
          <td class="text-right">
            <button class="btn-ghost btn btnDel" title="ì‚­ì œ">ì‚­ì œ</button>
          </td>
        </tr>
      `);
          $tbody.append($tr);
        });
        syncHeadCheck();
        recalc();
      }

      /* ---------------------------
     í•©ê³„ ê³„ì‚°
     - ë°°ì†¡ë¹„ ì •ì±…: ì„ íƒìƒí’ˆ í•©ê³„ê°€ 30,000ì› ë¯¸ë§Œì´ë©´ 3,000ì›, ì´ìƒì´ë©´ 0ì› (ì˜ˆì‹œ)
  ----------------------------*/
      function recalc() {
        let sumProducts = 0,
          sumDiscount = 0,
          sumLine = 0,
          selectedCount = 0;
        cart.forEach((it) => {
          if (!it.checked) return;
          selectedCount++;
          sumProducts += it.price * it.qty;
          sumDiscount += it.discount * it.qty;
        });
        sumLine = sumProducts - sumDiscount;
        const shipping = sumLine > 0 && sumLine < 30000 ? 3000 : 0;
        const grand = sumLine + shipping;

        $("#sum-products").text(fmt(sumProducts));
        $("#sum-discount").text("âˆ’ " + fmt(sumDiscount).replace("â‚© ", ""));
        $("#sum-shipping").text(fmt(shipping));
        $("#sum-total").text(fmt(grand));
      }

      function syncHeadCheck() {
        const total = cart.length;
        const checked = cart.filter((i) => i.checked).length;
        $("#headCheck").prop("checked", total > 0 && total === checked);
      }

      /* ---------------------------
     ì´ë²¤íŠ¸
  ----------------------------*/
      $(document).on("change", "#headCheck", function () {
        const on = $(this).is(":checked");
        cart = cart.map((it) => ({ ...it, checked: on }));
        $(".rowCheck").prop("checked", on);
        recalc();
      });

      $(document).on("change", ".rowCheck", function () {
        const id = rowId(this);
        const on = $(this).is(":checked");
        const it = cart.find((i) => i.id === id);
        if (it) {
          it.checked = on;
        }
        syncHeadCheck();
        recalc();
      });

      $(document).on("click", ".btnPlus", function () {
        const id = rowId(this);
        const it = cart.find((i) => i.id === id);
        it.qty = clampQty(it.qty + 1);
        updateRow(id);
      });

      $(document).on("click", ".btnMinus", function () {
        const id = rowId(this);
        const it = cart.find((i) => i.id === id);
        it.qty = clampQty(it.qty - 1);
        updateRow(id);
      });

      $(document).on("input change", ".qtyInput", function () {
        const id = rowId(this);
        const it = cart.find((i) => i.id === id);
        it.qty = clampQty($(this).val());
        updateRow(id);
      });

      $(document).on("click", ".btnDel", function () {
        const id = rowId(this);
        cart = cart.filter((i) => i.id !== id);
        render();
        // TODO: ì‹¤ì œ ì„œë²„ ì‚­ì œì—°ë™
        // $.post("/cart/delete.do", { cartId:id }, function(){ ... });
      });

      $("#btnDelSel, #btnDelSel2").on("click", function () {
        const before = cart.length;
        cart = cart.filter((i) => (!i.checked ? true : false)); // ì„ íƒëœ ê²ƒë§Œ ì œê±°
        if (cart.length === before) {
          alert("ì„ íƒëœ ìƒí’ˆì´ ì—†ì–´ìš”.");
          return;
        }
        render();
        // TODO: ì„œë²„ì— ì¼ê´„ì‚­ì œ ìš”ì²­
        // $.ajax({ url:"/cart/deleteSelected.do", type:"post", data:{ ids:selectedIds() } })
      });

      $("#btnWishSel, #btnWishSel2").on("click", function () {
        const ids = selectedIds();
        if (ids.length === 0) {
          alert("ì„ íƒëœ ìƒí’ˆì´ ì—†ì–´ìš”.");
          return;
        }
        alert("ì„ íƒìƒí’ˆì„ ê´€ì‹¬ëª©ë¡ì— ë‹´ì•˜ì–´ìš”! (ë°ëª¨)");
        // TODO: ì„œë²„ ê´€ì‹¬ë“±ë¡
        // $.post("/wish/addSelected.do", { ids }, ()=>{ ... });
      });

      $("#btnOrderSel").on("click", function () {
        const ids = selectedIds();
        if (ids.length === 0) {
          alert("ì„ íƒëœ ìƒí’ˆì´ ì—†ì–´ìš”.");
          return;
        }
        // ë°ëª¨: ì¿¼ë¦¬ìŠ¤íŠ¸ë§ë¡œ ì´ë™
        location.href =
          "/order/checkout.do?ids=" + encodeURIComponent(ids.join(","));
        // ì‹¤ì œë¡œëŠ” POSTë¡œ ì„ íƒëª©ë¡ ì„œë²„ ì„¸ì…˜ì— ë‹´ê³  í˜ì´ì§€ ì´ë™ ê¶Œì¥
      });

      $("#btnOrderAll").on("click", function () {
        if (cart.length === 0) {
          alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆì–´ìš”.");
          return;
        }
        location.href = "/order/checkout.do?all=1";
      });

      /* ---------------------------
     í–‰/ì„ íƒ í—¬í¼
  ----------------------------*/
      function rowId(el) {
        return parseInt($(el).closest("tr").data("id"), 10);
      }
      function selectedIds() {
        return cart.filter((i) => i.checked).map((i) => i.id);
      }
      function updateRow(id) {
        const it = cart.find((i) => i.id === id);
        const $tr = $(`tr[data-id="${id}"]`);
        $tr.find(".qtyInput").val(it.qty);
        const line = (it.price - it.discount) * it.qty;
        $tr.find(".lineTotal").text(fmt(line));
        recalc();

        // TODO: ì„œë²„ì— ìˆ˜ëŸ‰ ë³€ê²½ ë°˜ì˜
        // $.post("/cart/updateQty.do", { cartId:id, qty:it.qty });
      }

      function escapeHtml(str = "") {
        return String(str).replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[s])
        );
      }

      /* ì´ˆê¸° ë Œë” */
      $(function () {
        render();
      });
    </script>
  </body>
</html>
